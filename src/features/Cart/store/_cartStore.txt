// @ts-nocheck
import { create } from "zustand";

// Helper function untuk menghitung subtotal
const calculateSubtotal = (item) => {
    const price = Number(item.sell_price);
    const qty = Number(item.qty);
    let subtotal = price * qty;

    if (item.discountType == "percent") {
        subtotal -= subtotal * (Number(item.discountValue) / 100);
    } else if (item.discountType == "amount") {
        subtotal -= Number(item.discountValue);
    }

    return subtotal > 0 ? subtotal : 0;
};

// Helper untuk simpan ke localStorage
const saveCartToLocalStorage = (cart) => {
    localStorage.setItem("cart", JSON.stringify(cart));
};

// Helper untuk ambil dari localStorage
const getCartFromLocalStorage = () => {
    const stored = localStorage.getItem("cart");
    if (stored) {
        try {
            return JSON.parse(stored);
        } catch {
            return [];
        }
    }
    return [];
};

export const useCartStore = create((set, get) => ({
    cart: getCartFromLocalStorage(), // inisialisasi dari localStorage

    addToCart: (product, qty = 1) => {
        set((state) => {
            const existing = state.cart.find((item) => item.mtrl_code == product.mtrl_code);

            let updatedCart;
            if (existing) {
                // Kalau produk sudah ada, update qty
                updatedCart = state.cart.map((item) => {
                    if (item.mtrl_code == product.mtrl_code) {
                        const newQty = item.qty + qty;
                        return {
                            ...item,
                            qty: newQty,
                            subtotal: calculateSubtotal({ ...item, qty: newQty }),
                        };
                    }
                    return item;
                });
            } else {
                // Produk baru
                const newItem = {
                    mtrl_code: product.mtrl_code,
                    barcode: product.barcode,
                    mtrl_name: product.mtrl_name,
                    perhitungan_stock: product.perhitungan_stock,
                    type_id: product.type_id,
                    type_name: product.type_name,
                    satuan: product.satuan,
                    buy_price: product.buy_price,
                    sell_price: product.sell_price,
                    grosir_price: product.grosir_price,
                    stock: product.stock,
                    qty,
                    discountType: null, // 'percent' | 'amount' | null
                    discountValue: 0,
                    subtotal: calculateSubtotal({ ...product, qty, discountType: null, discountValue: 0 }),
                };
                updatedCart = [...state.cart, newItem];
            }

            // Simpan ke localStorage
            saveCartToLocalStorage(updatedCart);
            return { cart: updatedCart };
        });
    },

    removeFromCart: (mtrl_code) => {
        set((state) => {
            const updatedCart = state.cart.filter((item) => item.mtrl_code !== mtrl_code);
            saveCartToLocalStorage(updatedCart);
            return { cart: updatedCart };
        });
    },

    updateQty: (mtrl_code, qty) => {
        set((state) => {
            const updatedCart = state.cart.map((item) => {
                if (item.mtrl_code == mtrl_code) {
                    return {
                        ...item,
                        qty,
                        subtotal: calculateSubtotal({ ...item, qty }),
                    };
                }
                return item;
            });
            saveCartToLocalStorage(updatedCart);
            return { cart: updatedCart };
        });
    },

    updateDiscount: (mtrl_code, discountType, discountValue) => {
        set((state) => {
            const updatedCart = state.cart.map((item) => {
                if (item.mtrl_code == mtrl_code) {
                    return {
                        ...item,
                        discountType,
                        discountValue,
                        subtotal: calculateSubtotal({ ...item, discountType, discountValue }),
                    };
                }
                return item;
            });
            saveCartToLocalStorage(updatedCart);
            return { cart: updatedCart };
        });
    },

    clearCart: () => {
        saveCartToLocalStorage([]);
        set({ cart: [] });
    },
}));
